# VNPT RAG System

Há»‡ thá»‘ng RAG (Retrieval-Augmented Generation) Ä‘Ã¡nh giÃ¡ hiá»‡u nÄƒng cá»§a cÃ¡c mÃ´ hÃ¬nh AI VNPT vÃ  OpenAI trÃªn bá»™ dá»¯ liá»‡u Q&A vá»›i nhiá»u chiáº¿n lÆ°á»£c tá»‘i Æ°u.

---

## ğŸ“‹ Má»¥c lá»¥c

- [TÃ­nh nÄƒng chÃ­nh](#-tÃ­nh-nÄƒng-chÃ­nh)
- [CÃ i Ä‘áº·t mÃ´i trÆ°á»ng](#-cÃ i-Ä‘áº·t-mÃ´i-trÆ°á»ng)
- [Cáº¥u hÃ¬nh API Keys](#-cáº¥u-hÃ¬nh-api-keys)
- [CÃ¡ch sá»­ dá»¥ng](#-cÃ¡ch-sá»­-dá»¥ng)
- [CÃ¡c chiáº¿n lÆ°á»£c Ä‘Ã¡nh giÃ¡](#-cÃ¡c-chiáº¿n-lÆ°á»£c-Ä‘Ã¡nh-giÃ¡)
- [Cáº¥u trÃºc dá»± Ã¡n](#-cáº¥u-trÃºc-dá»±-Ã¡n)

---

## âœ¨ TÃ­nh nÄƒng chÃ­nh

- âœ… **Unified Pipeline**: Há»‡ thá»‘ng Ä‘Ã¡nh giÃ¡ thá»‘ng nháº¥t vá»›i 4 chiáº¿n lÆ°á»£c
- âœ… **Multi-Provider**: Há»— trá»£ cáº£ VNPT AI vÃ  OpenAI models
- âœ… **Improved Prompts**: Tá»‘i Æ°u prompts cho tá»«ng loáº¡i cÃ¢u há»i (MATH, CONTEXT, KNOWLEDGE)
- âœ… **Hybrid Strategy**: Káº¿t há»£p model lá»›n vÃ  nhá» Ä‘á»ƒ tá»‘i Æ°u chi phÃ­/hiá»‡u nÄƒng
- âœ… **Safety Classifier**: PhÃ¡t hiá»‡n vÃ  xá»­ lÃ½ cÃ¢u há»i khÃ´ng an toÃ n
- âœ… **Semantic Filtering**: Lá»c context dá»±a trÃªn Ä‘á»™ tÆ°Æ¡ng Ä‘á»“ng ngá»¯ nghÄ©a
- âœ… **Flexible Configuration**: Cáº¥u hÃ¬nh linh hoáº¡t qua command line

---

## ğŸ CÃ i Ä‘áº·t mÃ´i trÆ°á»ng

### 1. CÃ i Ä‘áº·t Conda (náº¿u chÆ°a cÃ³)

```bash
# Táº£i Miniconda (phiÃªn báº£n nháº¹ cá»§a Conda)
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh

# CÃ i Ä‘áº·t
bash Miniconda3-latest-Linux-x86_64.sh

# Khá»Ÿi Ä‘á»™ng láº¡i terminal hoáº·c cháº¡y
source ~/.bashrc
```

### 2. Táº¡o mÃ´i trÆ°á»ng Conda má»›i

```bash
# Táº¡o mÃ´i trÆ°á»ng vá»›i Python 3.10
conda create -n vnpt-ai python=3.10 -y

# KÃ­ch hoáº¡t mÃ´i trÆ°á»ng
conda activate vnpt-ai
```

### 3. CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t

```bash
# CÃ i Ä‘áº·t cÃ¡c package chÃ­nh
pip install requests openai numpy
```

**CÃ¡c thÆ° viá»‡n cáº§n thiáº¿t:**
- `requests` - Gá»i API HTTP
- `openai` - OpenAI Python SDK
- `numpy` - Xá»­ lÃ½ vector cho semantic filtering

---

## ğŸ”‘ Cáº¥u hÃ¬nh API Keys

### VNPT AI API Configuration

File: `src/configs/api-keys.json`

**Cáº¥u trÃºc:**

```json
[
  {
    "authorization": "Bearer <JWT_TOKEN>",
    "tokenKey": "<TOKEN_KEY>",
    "llmApiName": "LLM large",
    "tokenId": "<TOKEN_ID>"
  },
  {
    "authorization": "Bearer <JWT_TOKEN>",
    "tokenKey": "<TOKEN_KEY>",
    "llmApiName": "LLM small",
    "tokenId": "<TOKEN_ID>"
  },
  {
    "authorization": "Bearer <JWT_TOKEN>",
    "tokenKey": "<TOKEN_KEY>",
    "llmApiName": "LLM embedings",
    "tokenId": "<TOKEN_ID>"
  }
]
```

**LÆ°u Ã½:**
- Index 0: Model **large** (máº¡nh nháº¥t, cho cÃ¢u há»i khÃ³)
- Index 1: Model **small** (nháº¹ hÆ¡n, cho cÃ¢u há»i Ä‘Æ¡n giáº£n)
- Index 2: Model **embeddings** (táº¡o vector cho semantic search)

**CÃ¡ch thiáº¿t láº­p:**

```bash
cd src/configs
cp api-keys.json.example api-keys.json
# Sau Ä‘Ã³ chá»‰nh sá»­a file api-keys.json vá»›i thÃ´ng tin cá»§a báº¡n
```

---

### OpenAI API Configuration

File: `src/configs/openai_config.json`

**Cáº¥u trÃºc:**

```json
{
  "openai": {
    "base_url": "https://api.openai.com/v1",
    "api_key": "sk-proj-xxxxxxxxxxxx",
    "model": "gpt-4o-mini"
  }
}
```

**CÃ¡c trÆ°á»ng:**
- `base_url`: URL endpoint cá»§a OpenAI API
- `api_key`: API key cá»§a báº¡n tá»« [OpenAI Platform](https://platform.openai.com/api-keys)
- `model`: TÃªn model máº·c Ä‘á»‹nh (vÃ­ dá»¥: `gpt-4o-mini`, `gpt-4o`, `gpt-3.5-turbo`)

**CÃ¡ch thiáº¿t láº­p:**

```bash
cd src/configs
cp openai_config.json.example openai_config.json
# Sau Ä‘Ã³ chá»‰nh sá»­a file openai_config.json vá»›i API key cá»§a báº¡n
```

---

## ğŸš€ CÃ¡ch sá»­ dá»¥ng

### Quick Start

```bash
# KÃ­ch hoáº¡t mÃ´i trÆ°á»ng
conda activate vnpt-ai

# Cháº¡y vá»›i Hybrid strategy vÃ  VNPT models (Khuyáº¿n nghá»‹)
python main.py --strategy hybrid --provider vnpt

# Cháº¡y vá»›i OpenAI models
python main.py --strategy hybrid --provider openai

# Test nhanh vá»›i 50 cÃ¢u há»i
python main.py --strategy hybrid --max-questions 50 --verbose
```

### CÃ¡c tham sá»‘ dÃ²ng lá»‡nh

#### Strategy Arguments

| Tham sá»‘ | MÃ´ táº£ | GiÃ¡ trá»‹ | Máº·c Ä‘á»‹nh |
|---------|-------|---------|----------|
| `--strategy` | Chiáº¿n lÆ°á»£c Ä‘Ã¡nh giÃ¡ | `baseline`, `hybrid`, `cost-optimized`, `quality-optimized` | `baseline` |
| `--provider` | NhÃ  cung cáº¥p model | `vnpt`, `openai` | `vnpt` |
| `--large-model` | TÃªn model lá»›n | `large` (VNPT), `gpt-4o-mini` (OpenAI) | `large` |
| `--small-model` | TÃªn model nhá» | `small` (VNPT), `gpt-3.5-turbo` (OpenAI) | `small` |

#### Data Arguments

| Tham sá»‘ | MÃ´ táº£ | Máº·c Ä‘á»‹nh |
|---------|-------|----------|
| `--input` | File JSON chá»©a cÃ¢u há»i | `data/val.json` |
| `--max-questions` | Sá»‘ cÃ¢u há»i tá»‘i Ä‘a Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ | Táº¥t cáº£ |
| `--start-index` | Index báº¯t Ä‘áº§u (0-based) | `0` |
| `--end-index` | Index káº¿t thÃºc (exclusive) | Cuá»‘i danh sÃ¡ch |

#### Output Arguments

| Tham sá»‘ | MÃ´ táº£ | Máº·c Ä‘á»‹nh |
|---------|-------|----------|
| `--verbose` | In chi tiáº¿t cho má»—i cÃ¢u há»i | `False` |
| `--no-save` | KhÃ´ng lÆ°u káº¿t quáº£ vÃ o file | `False` |
| `--save-predictions` | LÆ°u predictions vÃ o CSV | `False` |
| `--output-dir` | ThÆ° má»¥c lÆ°u káº¿t quáº£ | `.` (thÆ° má»¥c hiá»‡n táº¡i) |

#### Prompt Arguments

| Tham sá»‘ | MÃ´ táº£ | Máº·c Ä‘á»‹nh |
|---------|-------|----------|
| `--no-improved-prompts` | Táº¯t improved prompts | `False` |

---

## ğŸ“Š CÃ¡c chiáº¿n lÆ°á»£c Ä‘Ã¡nh giÃ¡

### 1. Baseline Strategy

Sá»­ dá»¥ng model lá»›n cho táº¥t cáº£ cÃ¢u há»i.

```bash
python main.py --strategy baseline --provider vnpt
```

**Äáº·c Ä‘iá»ƒm:**
- âœ… Accuracy cao nháº¥t
- âŒ Chi phÃ­ cao nháº¥t
- ğŸ¯ PhÃ¹ há»£p: ÄÃ¡nh giÃ¡ baseline, so sÃ¡nh hiá»‡u nÄƒng

### 2. Hybrid Strategy â­ (Khuyáº¿n nghá»‹)

Káº¿t há»£p model lá»›n vÃ  nhá» dá»±a trÃªn Ä‘á»™ phá»©c táº¡p cÃ¢u há»i.

```bash
python main.py --strategy hybrid --provider vnpt
```

**Äáº·c Ä‘iá»ƒm:**
- âœ… CÃ¢n báº±ng tá»‘t giá»¯a chi phÃ­ vÃ  accuracy
- âœ… Tiáº¿t kiá»‡m ~35% chi phÃ­ so vá»›i baseline
- âœ… Giá»¯ Ä‘Æ°á»£c ~90% accuracy
- ğŸ¯ PhÃ¹ há»£p: Production, sá»­ dá»¥ng thá»±c táº¿

**Logic:**
- CÃ¢u há»i MATH (khÃ³) â†’ Model lá»›n
- CÃ¢u há»i CONTEXT (Ä‘Æ¡n giáº£n) â†’ Model nhá»
- CÃ¢u há»i KNOWLEDGE (trung bÃ¬nh) â†’ Model lá»›n

### 3. Cost-Optimized Strategy

Æ¯u tiÃªn giáº£m chi phÃ­, cháº¥p nháº­n giáº£m accuracy.

```bash
python main.py --strategy cost-optimized --provider vnpt
```

**Äáº·c Ä‘iá»ƒm:**
- âœ… Tiáº¿t kiá»‡m ~50% chi phÃ­
- âŒ Accuracy giáº£m ~5-7%
- ğŸ¯ PhÃ¹ há»£p: MÃ´i trÆ°á»ng dev/test, budget háº¡n cháº¿

### 4. Quality-Optimized Strategy

Æ¯u tiÃªn accuracy cao nháº¥t, khÃ´ng quan tÃ¢m chi phÃ­.

```bash
python main.py --strategy quality-optimized --provider vnpt
```

**Äáº·c Ä‘iá»ƒm:**
- âœ… Accuracy cao nháº¥t (~95%)
- âŒ Chi phÃ­ cao nháº¥t
- âœ… Sá»­ dá»¥ng improved prompts vÃ  safety checks
- ğŸ¯ PhÃ¹ há»£p: ÄÃ¡nh giÃ¡ cuá»‘i cÃ¹ng, demo quan trá»ng

---

## ğŸ“ˆ So sÃ¡nh hiá»‡u nÄƒng

| Chiáº¿n lÆ°á»£c | Chi phÃ­ | Accuracy | MATH | CONTEXT | KNOWLEDGE |
|------------|---------|----------|------|---------|-----------|
| **Baseline** | 100% | ~92% | 85% | 100% | 90% |
| **Hybrid** â­ | 65% | ~90% | 85%+ | 100% | 88% |
| **Cost-Optimized** | 50% | ~85% | 80% | 95% | 85% |
| **Quality-Optimized** | 100% | ~95% | 95% | 100% | 95% |

---

## ğŸ’¡ VÃ­ dá»¥ sá»­ dá»¥ng

### ÄÃ¡nh giÃ¡ cÆ¡ báº£n

```bash
# ÄÃ¡nh giÃ¡ vá»›i VNPT models
python main.py --strategy hybrid --provider vnpt --input data/val.json

# ÄÃ¡nh giÃ¡ vá»›i OpenAI models
python main.py --strategy hybrid --provider openai \
  --large-model gpt-4o-mini --small-model gpt-3.5-turbo
```

### ÄÃ¡nh giÃ¡ vá»›i giá»›i háº¡n

```bash
# ÄÃ¡nh giÃ¡ 100 cÃ¢u há»i Ä‘áº§u tiÃªn
python main.py --strategy hybrid --max-questions 100

# ÄÃ¡nh giÃ¡ tá»« cÃ¢u 10 Ä‘áº¿n cÃ¢u 50
python main.py --strategy hybrid --start-index 10 --end-index 50
```

### ÄÃ¡nh giÃ¡ vá»›i verbose vÃ  lÆ°u káº¿t quáº£

```bash
# Verbose mode Ä‘á»ƒ debug
python main.py --strategy hybrid --max-questions 10 --verbose

# LÆ°u predictions vÃ o CSV
python main.py --strategy hybrid --save-predictions

# LÆ°u káº¿t quáº£ vÃ o thÆ° má»¥c cá»¥ thá»ƒ
python main.py --strategy hybrid --output-dir ./results
```

### So sÃ¡nh cÃ¡c chiáº¿n lÆ°á»£c

```bash
# Cháº¡y táº¥t cáº£ cÃ¡c chiáº¿n lÆ°á»£c Ä‘á»ƒ so sÃ¡nh
python main.py --strategy baseline --max-questions 100
python main.py --strategy hybrid --max-questions 100
python main.py --strategy cost-optimized --max-questions 100
python main.py --strategy quality-optimized --max-questions 100
```

### So sÃ¡nh VNPT vs OpenAI

```bash
# VNPT models
python main.py --strategy hybrid --provider vnpt --max-questions 50

# OpenAI models
python main.py --strategy hybrid --provider openai \
  --large-model gpt-4o-mini --small-model gpt-3.5-turbo --max-questions 50
```

### Táº¯t improved prompts Ä‘á»ƒ so sÃ¡nh

```bash
# Vá»›i improved prompts (máº·c Ä‘á»‹nh)
python main.py --strategy hybrid --max-questions 50

# KhÃ´ng dÃ¹ng improved prompts
python main.py --strategy hybrid --no-improved-prompts --max-questions 50
```

---

## ğŸ“ Cáº¥u trÃºc dá»± Ã¡n

```
vnpt_rag_system/
â”œâ”€â”€ main.py                      # Entry point chÃ­nh
â”œâ”€â”€ README.MD                    # File nÃ y
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ val.json                # Bá»™ dá»¯ liá»‡u validation
â”‚   â””â”€â”€ test.json               # Bá»™ dá»¯ liá»‡u test
â””â”€â”€ src/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ clients/                # API clients
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ factory.py          # Factory pattern cho clients
    â”‚   â”œâ”€â”€ vnpt.py             # VNPT AI client
    â”‚   â””â”€â”€ openai.py           # OpenAI client
    â”œâ”€â”€ components/             # Core components
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ classifier.py       # Question classifier
    â”‚   â”œâ”€â”€ extractor.py        # Answer extractor
    â”‚   â”œâ”€â”€ model.py            # Model wrapper
    â”‚   â”œâ”€â”€ prompt_builder.py   # Basic prompt builder
    â”‚   â”œâ”€â”€ improved_prompt_builder.py  # Improved prompts â­
    â”‚   â”œâ”€â”€ retrieval.py        # Semantic context filter
    â”‚   â”œâ”€â”€ safety_classifier.py # Safety classifier
    â”‚   â””â”€â”€ vector_db.py        # Vector database
    â”œâ”€â”€ configs/                # Configuration files
    â”‚   â”œâ”€â”€ api-keys.json       # VNPT API keys (khÃ´ng commit)
    â”‚   â”œâ”€â”€ api-keys.json.example
    â”‚   â”œâ”€â”€ openai_config.json  # OpenAI config (khÃ´ng commit)
    â”‚   â””â”€â”€ openai_config.json.example
    â”œâ”€â”€ pipelines/              # Evaluation pipelines
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ standard.py         # Standard pipeline
    â”‚   â”œâ”€â”€ hybrid.py           # Hybrid pipeline
    â”‚   â””â”€â”€ unified.py          # Unified pipeline â­
    â””â”€â”€ utils/                  # Utility functions
        â”œâ”€â”€ __init__.py
        â””â”€â”€ format_choices.py   # Dynamic choices formatter
```

---

## ğŸ” Chi tiáº¿t cÃ¡c components

### Clients (`src/clients/`)

- **factory.py**: Factory pattern Ä‘á»ƒ táº¡o client phÃ¹ há»£p
- **vnpt.py**: Client cho VNPT AI API
- **openai.py**: Client cho OpenAI API

### Components (`src/components/`)

- **classifier.py**: PhÃ¢n loáº¡i cÃ¢u há»i (MATH, CONTEXT, KNOWLEDGE)
- **safety_classifier.py**: PhÃ¡t hiá»‡n cÃ¢u há»i khÃ´ng an toÃ n
- **extractor.py**: TrÃ­ch xuáº¥t cÃ¢u tráº£ lá»i tá»« output cá»§a model
- **prompt_builder.py**: XÃ¢y dá»±ng prompt cÆ¡ báº£n
- **improved_prompt_builder.py**: Prompt Ä‘Æ°á»£c tá»‘i Æ°u cho tá»«ng loáº¡i cÃ¢u há»i
- **retrieval.py**: Lá»c context dá»±a trÃªn semantic similarity
- **vector_db.py**: Vector database cho embeddings
- **model.py**: Wrapper thá»‘ng nháº¥t cho cÃ¡c model

### Pipelines (`src/pipelines/`)

- **standard.py**: Pipeline cÆ¡ báº£n (baseline)
- **hybrid.py**: Pipeline káº¿t há»£p model lá»›n vÃ  nhá»
- **unified.py**: Pipeline thá»‘ng nháº¥t vá»›i 4 chiáº¿n lÆ°á»£c

---

## ğŸ“ Format dá»¯ liá»‡u

### Input Format (JSON)

```json
[
  {
    "id": "question_001",
    "question": "CÃ¢u há»i cá»§a báº¡n?",
    "choices": ["A. ÄÃ¡p Ã¡n A", "B. ÄÃ¡p Ã¡n B", "C. ÄÃ¡p Ã¡n C", "D. ÄÃ¡p Ã¡n D"],
    "answer": "A",
    "context": "Context liÃªn quan Ä‘áº¿n cÃ¢u há»i..."
  }
]
```

### Output Format

**Console Output:**

```
=== EVALUATION RESULTS ===
Strategy: hybrid
Provider: vnpt
Total questions: 100
Correct: 90
Accuracy: 90.00%
Total time: 45.23s
Average time: 0.45s/question
```

**CSV Output** (náº¿u dÃ¹ng `--save-predictions`):

```csv
id,question,predicted,actual,correct
question_001,"CÃ¢u há»i?",A,A,True
question_002,"CÃ¢u há»i?",B,A,False
```

---

## ğŸ› Troubleshooting

### Module Import Errors

```bash
# Äáº£m báº£o báº¡n Ä‘ang á»Ÿ thÆ° má»¥c gá»‘c cá»§a project
cd /path/to/vnpt_rag_system

# Cháº¡y tá»« thÆ° má»¥c gá»‘c
python main.py --strategy hybrid
```

### File Not Found Errors

```bash
# Sá»­ dá»¥ng Ä‘Æ°á»ng dáº«n Ä‘Ãºng tá»« thÆ° má»¥c gá»‘c
python main.py --input data/val.json  # âœ… ÄÃºng
python main.py --input ../data/val.json  # âŒ Sai (náº¿u Ä‘ang á»Ÿ thÆ° má»¥c gá»‘c)
```

### API Key Errors

```bash
# Kiá»ƒm tra file config tá»“n táº¡i
ls src/configs/api-keys.json
ls src/configs/openai_config.json

# Kiá»ƒm tra format JSON há»£p lá»‡
python -m json.tool src/configs/api-keys.json
```

---

## ğŸ“š TÃ i liá»‡u tham kháº£o

- [OpenAI API Documentation](https://platform.openai.com/docs)
- [VNPT AI Platform](https://ai.vnpt.vn)

---

## ğŸ‘¥ Contributors

- VNPT AI Team

---

## ğŸ“„ License

Internal use only - VNPT Corporation
